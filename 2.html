<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Management System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      position: relative;
      color: #333;
    }

    body::before {
      content: "TECHNOMENS";
      position: fixed;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 100px;
      color: rgba(41, 61, 64, 0.15);
      z-index: 0;
      pointer-events: none;
      white-space: nowrap;
      font-weight: bold;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
      flex-wrap: wrap;
      gap: 15px;
    }

    h1 {
      margin: 0;
      color: #2c3e50;
      font-size: 28px;
    }

    .search-container {
      position: relative;
      min-width: 250px;
    }

    .search-logo {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
    }

    .search-input {
      padding: 10px 40px 10px 40px;
      border-radius: 25px;
      border: 1px solid #ddd;
      width: 100%;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
    }

    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }

    .form-container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }

    .form-title {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-title i {
      color: #4CAF50;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      flex: 1;
      min-width: 200px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 14px;
      transition: all 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    button {
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
    }

    .submit-btn:hover {
      background-color: #3d8b40;
      transform: translateY(-2px);
    }

    .dispatch-btn {
      background-color: #FF9800;
      color: white;
      border: none;
    }

    .dispatch-btn:hover {
      background-color: #F57C00;
      transform: translateY(-2px);
    }

    .cancel-btn {
      background-color: #f5f5f5;
      color: #555;
      border: 1px solid #ddd;
    }

    .cancel-btn:hover {
      background-color: #eaeaea;
    }

    .tab-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background-color: #e0e0e0;
      color: #333;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background-color: #4CAF50;
      color: white;
    }

    .tab-btn:hover {
      background-color: #d0d0d0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      position: relative;
      z-index: 1;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
    }

    th, td {
      padding: 15px;
      border: 1px solid #e0e0e0;
      text-align: center;
    }

    th {
      background-color: #4CAF50;
      color: white;
      position: sticky;
      top: 0;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.5px;
    }

    tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tr:hover {
      background-color: #f0f0f0;
    }

    .qr {
      height: 50px;
      width: auto;
      max-width: 150px;
    }

    .action-btns {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .delete-btn {
      background-color: #f44336;
      color: white;
      border: none;
    }

    .delete-btn:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
    }

    .edit-btn {
      background-color: #2196F3;
      color: white;
      border: none;
    }

    .edit-btn:hover {
      background-color: #1976D2;
      transform: translateY(-2px);
    }

    .status-low {
      color: #f44336;
      font-weight: bold;
    }

    .status-medium {
      color: #FF9800;
      font-weight: bold;
    }

    .status-high {
      color: #4CAF50;
      font-weight: bold;
    }

    .details-panel {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-top: 30px;
      position: relative;
      z-index: 1;
      display: none;
    }

    .details-title {
      margin-top: 0;
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .details-title i {
      color: #4CAF50;
    }

    .details-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .detail-item {
      margin-bottom: 15px;
    }

    .detail-label {
      font-weight: bold;
      color: #555;
      margin-bottom: 5px;
      display: block;
    }

    .detail-value {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .spec-value {
      white-space: pre-wrap;
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
      grid-column: 1 / -1;
    }

    .loading-message {
      text-align: center;
      padding: 30px;
      color: #777;
      font-size: 16px;
    }

    .chatbot-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .chatbot-toggle {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }

    .chatbot-toggle:hover {
      background-color: #3d8b40;
      transform: scale(1.1);
    }

    .chatbot-window {
      display: none;
      background: white;
      width: 320px;
      max-height: 500px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: hidden;
      flex-direction: column;
      margin-bottom: 10px;
    }

    .chatbot-header {
      background-color: #4CAF50;
      color: white;
      padding: 15px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chatbot-mode-toggle {
      background: #3d8b40;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .chatbot-mode-toggle:hover {
      background: #2e7d32;
    }

    .chatbot-messages {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      max-height: 350px;
      background-color: #f9f9f9;
    }

    .chatbot-message {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .chatbot-message.user {
      background-color: #4CAF50;
      color: white;
      margin-left: 20%;
      margin-right: 10px;
    }

    .chatbot-message.bot {
      background-color: #e0e0e0;
      color: #333;
      margin-right: 20%;
      margin-left: 10px;
    }

    .chatbot-input-container {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    .chatbot-input {
      flex-grow: 1;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      margin-right: 10px;
    }

    .chatbot-input:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .chatbot-send {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-send:hover {
      background-color: #3d8b40;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }

      .search-container {
        width: 100%;
      }

      .form-row {
        flex-direction: column;
        gap: 15px;
      }

      .action-btns {
        flex-direction: column;
        gap: 5px;
      }

      th, td {
        padding: 10px 5px;
        font-size: 13px;
      }

      .details-content {
        grid-template-columns: 1fr;
      }

      .chatbot-window {
        width: 100%;
        max-width: 300px;
        max-height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1><i class="fas fa-boxes"></i> Inventory Management System</h1>
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="search-input" class="search-input" placeholder="Search inventory...">
      <img src="1logo.png" alt="Logo" class="search-logo">
    </div>
  </div>

  <div class="tab-container">
    <button class="tab-btn active" id="inventory-tab">Inventory</button>
    <button class="tab-btn" id="purchase-tab">Inwards</button>
    <button class="tab-btn" id="sales-tab">Outwards</button>
  </div>

  <div id="inventory-section">
    <div class="form-container">
      <h2 class="form-title" id="form-title"><i class="fas fa-plus-circle"></i> Add Purchase or Sale</h2>
      <form id="inventory-form">
        <div class="form-row">
          <div class="form-group">
            <label for="transaction-type">Transaction Type</label>
            <select id="transaction-type" required>
              <option value="purchase">Purchase</option>
              <option value="sale">Sale</option>
            </select>
          </div>
          <div class="form-group">
            <label for="part-code">Part Code</label>
            <input type="text" id="part-code" placeholder="Enter part code" required>
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description-input" placeholder="Enter description" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="make">Make</label>
            <input type="text" id="make" placeholder="Enter make" required>
          </div>
          <div class="form-group">
            <label for="hsn">HSN Code</label>
            <input type="text" id="hsn" placeholder="Enter HSN code" required>
          </div>
          <div class="form-group">
            <label for="category">Category</label>
            <select id="category" required>
              <option value="Mechanical">Mechanical</option>
              <option value="Electrical">Electrical</option>
              <option value="Chemical">Chemical</option>
              <option value="Miscellaneous">Miscellaneous</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="uom">Unit of Measurement</label>
            <select id="uom" required>
              <option value="Pieces">Pieces</option>
              <option value="Kg">Kg</option>
              <option value="Liters">Liters</option>
              <option value="Meters">Meters</option>
              <option value="Box">Box</option>
              <option value="Set">Set</option>
              <option value="Pair">Pair</option>
            </select>
          </div>
          <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" required>
          </div>
          <div class="form-group">
            <label for="type">Item Type</label>
            <select id="type" required>
              <option value="Raw Material">Raw Material</option>
              <option value="Finished Goods">Finished Goods</option>
              <option value="Semi-Finished">Semi-Finished</option>
              <option value="Consumables">Consumables</option>
              <option value="Tools">Tools</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group purchase-field">
            <label for="purchase-amount">Purchase Amount</label>
            <input type="number" id="purchase-amount" placeholder="Enter amount" step="0.01" min="0">
          </div>
          <div class="form-group purchase-field">
            <label for="purchase-qty">Purchase Quantity</label>
            <input type="number" id="purchase-qty" placeholder="0" min="0">
          </div>
          <div class="form-group purchase-field">
            <label for="purchase-from">Purchase From</label>
            <input type="text" id="purchase-from" placeholder="Enter supplier name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group sale-field" style="display: none;">
            <label for="sold-qty">Sold Quantity</label>
            <input type="number" id="sold-qty" placeholder="0" min="0">
          </div>
          <div class="form-group sale-field" style="display: none;">
            <label for="sold-price">Sold Price</label>
            <input type="number" id="sold-price" placeholder="Enter price" step="0.01" min="0">
          </div>
          <div class="form-group sale-field" style="display: none;">
            <label for="sold-to">Sold To</label>
            <input type="text" id="sold-to" placeholder="Enter customer name">
          </div>
          <div class="form-group">
            <label for="qr">QR Code</label>
            <div id="qr" style="margin-top: 10px;">
              <img id="qrImage" src="https://api.qrserver.com/v1/create-qr-code/?data=Default&size=100x100" alt="QR Code" title="QR Code" />
            </div>
            <button type="button" class="action-btn" id="download-json-btn" style="display: none; margin-top: 10px; background-color: #2196F3; color: white;">
              <i class="fas fa-download"></i> Download QR JSON
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="cancel-btn" id="cancel-btn" style="display: none;">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="submit" class="submit-btn" id="submit-btn">
            <i class="fas fa-plus"></i> Add Purchase
          </button>
          <button type="button" class="dispatch-btn" id="dispatch-btn" style="display: none;">
            <i class="fas fa-truck"></i> Record Sale
          </button>
        </div>
      </form>
    </div>

    <table id="inventory-table">
      <thead>
        <tr>
          <th>Part Code</th>
          <th>Description</th>
          <th>Make</th>
          <th>HSN</th>
          <th>Category</th>
          <th>Type</th>
          <th>UOM</th>
          <th>Purchase Qty</th>
          <th>Sold Qty</th>
          <th>Available Qty</th>
          <th>QR Code</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="inventory-body">
        <tr><td colspan="12" class="loading-message">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="purchase-section" style="display: none;">
    <table id="purchase-table">
      <thead>
        <tr>
          <th>Part Code</th>
          <th>Description</th>
          <th>Make</th>
          <th>HSN</th>
          <th>Category</th>
          <th>Type</th>
          <th>UOM</th>
          <th>Purchase Amount</th>
          <th>Purchase Qty</th>
          <th>Purchase From</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="purchase-body">
        <tr><td colspan="12" class="loading-message">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="sales-section" style="display: none;">
    <table id="sales-table">
      <thead>
        <tr>
          <th>Part Code</th>
          <th>Description</th>
          <th>Make</th>
          <th>HSN</th>
          <th>Category</th>
          <th>Type</th>
          <th>UOM</th>
          <th>Sold Qty</th>
          <th>Sold Price</th>
          <th>Sold To</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="sales-body">
        <tr><td colspan="12" class="loading-message">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="details-panel" id="details-panel">
    <h2 class="details-title"><i class="fas fa-info-circle"></i> Item Details</h2>
    <div class="details-content" id="details-content"></div>
  </div>

  <div class="chatbot-container">
    <button class="chatbot-toggle" id="chatbot-toggle" title="Open Chatbot">
      <i class="fas fa-comment-dots"></i>
    </button>
    <div class="chatbot-window" id="chatbot-window">
      <div class="chatbot-header">
        <span id="chatbot-title">Support Chatbot</span>
        <button class="chatbot-mode-toggle" id="chatbot-mode-toggle">Switch to Local Knowledge</button>
      </div>
      <div class="chatbot-messages" id="chatbot-messages">
        <div class="chatbot-message bot">Hello! How can I assist you with inventory management today?</div>
      </div>
      <div class="chatbot-input-container">
        <input type="text" class="chatbot-input" id="chatbot-input" placeholder="Type your message...">
        <button class="chatbot-send" id="chatbot-send"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAs8o4QO1YB8zaHq--4rMaYeCHAIOAfAEk",
      authDomain: "inventory-23e2b.firebaseapp.com",
      projectId: "inventory-23e2b",
      storageBucket: "inventory-23e2b.firebasestorage.app",
      messagingSenderId: "310713354936",
      appId: "1:310713354936:web:35cdf2af47e02b0ca7024d",
      measurementId: "G-GGD694N4HL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function generateQRData(item) {
      return JSON.stringify({
        transactionType: document.getElementById('transaction-type').value || 'N/A',
        partCode: item.partCode || 'N/A',
        description: item.description || 'N/A',
        make: item.make || 'N/A',
        hsn: item.hsn || 'N/A',
        category: item.category || 'N/A',
        type: item.type || 'N/A',
        uom: item.uom || 'N/A',
        purchaseAmount: item.purchaseAmount || 0,
        purchaseQty: item.purchaseQty || 0,
        purchaseFrom: item.purchaseFrom || 'N/A',
        soldQty: item.soldQty || 0,
        soldPrice: item.soldPrice || 0,
        soldTo: item.soldTo || 'N/A',
        date: item.date || 'N/A'
      });
    }

    function generateQRCode(data) {
      return `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(data)}&size=100x100`;
    }

    const form = document.getElementById('inventory-form');
    const tableBody = document.getElementById('inventory-body');
    const purchaseBody = document.getElementById('purchase-body');
    const salesBody = document.getElementById('sales-body');
    const searchInput = document.getElementById('search-input');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const dispatchBtn = document.getElementById('dispatch-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const detailsPanel = document.getElementById('details-panel');
    const detailsContent = document.getElementById('details-content');
    const inventorySection = document.getElementById('inventory-section');
    const purchaseSection = document.getElementById('purchase-section');
    const salesSection = document.getElementById('sales-section');
    const inventoryTab = document.getElementById('inventory-tab');
    const purchaseTab = document.getElementById('purchase-tab');
    const salesTab = document.getElementById('sales-tab');
    const transactionType = document.getElementById('transaction-type');
    const purchaseFields = document.querySelectorAll('.purchase-field');
    const saleFields = document.querySelectorAll('.sale-field');
    const qrImage = document.getElementById('qrImage');
    const downloadJsonBtn = document.getElementById('download-json-btn');

    let currentItemId = null;
    let unsubscribeItems = null;
    let unsubscribePurchases = null;
    let unsubscribeSales = null;

    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotWindow = document.getElementById('chatbot-window');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotModeToggle = document.getElementById('chatbot-mode-toggle');
    const chatbotTitle = document.getElementById('chatbot-title');
    let isSupportMode = true;

    // Set default date to today
    document.getElementById('date').valueAsDate = new Date();

    function toggleFormFields() {
      const type = transactionType.value;
      formTitle.innerHTML = `<i class="fas fa-plus-circle"></i> Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      submitBtn.innerHTML = `<i class="fas fa-plus"></i> Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
      dispatchBtn.style.display = type === 'sale' ? 'flex' : 'none';

      purchaseFields.forEach(field => {
        field.style.display = type === 'purchase' ? 'block' : 'none';
        const input = field.querySelector('input');
        input.required = type === 'purchase';
      });

      saleFields.forEach(field => {
        field.style.display = type === 'sale' ? 'block' : 'none';
        const input = field.querySelector('input');
        input.required = type === 'sale';
      });

      const item = {
        partCode: document.getElementById('part-code').value.trim(),
        description: document.getElementById('description-input').value.trim(),
        make: document.getElementById('make').value.trim(),
        hsn: document.getElementById('hsn').value.trim(),
        category: document.getElementById('category').value,
        type: document.getElementById('type').value,
        uom: document.getElementById('uom').value,
        purchaseAmount: parseFloat(document.getElementById('purchase-amount').value) || 0,
        purchaseQty: parseInt(document.getElementById('purchase-qty').value) || 0,
        purchaseFrom: document.getElementById('purchase-from').value.trim(),
        soldQty: parseInt(document.getElementById('sold-qty').value) || 0,
        soldPrice: parseFloat(document.getElementById('sold-price').value) || 0,
        soldTo: document.getElementById('sold-to').value.trim(),
        date: document.getElementById('date').value
      };
      qrImage.src = generateQRCode(generateQRData(item));
    }

    transactionType.addEventListener('change', toggleFormFields);

    ['part-code', 'description-input', 'make', 'hsn', 'category', 'type', 'uom', 'date',
     'purchase-amount', 'purchase-qty', 'purchase-from', 'sold-qty', 'sold-price', 'sold-to'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        const item = {
          partCode: document.getElementById('part-code').value.trim(),
          description: document.getElementById('description-input').value.trim(),
          make: document.getElementById('make').value.trim(),
          hsn: document.getElementById('hsn').value.trim(),
          category: document.getElementById('category').value,
          type: document.getElementById('type').value,
          uom: document.getElementById('uom').value,
          purchaseAmount: parseFloat(document.getElementById('purchase-amount').value) || 0,
          purchaseQty: parseInt(document.getElementById('purchase-qty').value) || 0,
          purchaseFrom: document.getElementById('purchase-from').value.trim(),
          soldQty: parseInt(document.getElementById('sold-qty').value) || 0,
          soldPrice: parseFloat(document.getElementById('sold-price').value) || 0,
          soldTo: document.getElementById('sold-to').value.trim(),
          date: document.getElementById('date').value
        };
        qrImage.src = generateQRCode(generateQRData(item));
      });
    });

    async function downloadPurchaseBill(purchaseId) {
      try {
        const docRef = db.collection('purchases').doc(purchaseId);
        const doc = await docRef.get();

        if (!doc.exists) {
          alert('Purchase record not found!');
          return;
        }

        const purchase = { id: doc.id, ...doc.data() };
        generatePurchaseBillPDF(purchase);
      } catch (error) {
        console.error('Error downloading purchase bill:', error);
        alert('Error generating purchase bill');
      }
    }

    async function downloadSalesBill(saleId) {
      try {
        const docRef = db.collection('sales').doc(saleId);
        const doc = await docRef.get();

        if (!doc.exists) {
          alert('Sales record not found!');
          return;
        }

        const sale = { id: doc.id, ...doc.data() };
        generateSalesBillPDF(sale);
      } catch (error) {
        console.error('Error downloading sales bill:', error);
        alert('Error generating sales bill');
      }
    }

    function generatePurchaseBillPDF(purchase) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(20);
      doc.setTextColor(40, 180, 99);
      doc.text('TECHNOMENS', 105, 20, { align: 'center' });
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('PURCHASE BILL', 105, 30, { align: 'center' });

      doc.setFontSize(12);
      doc.text(`Bill No: ${purchase.id || 'N/A'}`, 15, 45);
      doc.text(`Date: ${purchase.date || 'N/A'}`, 15, 55);
      doc.text(`Supplier: ${purchase.purchaseFrom || 'N/A'}`, 15, 65);

      doc.autoTable({
        startY: 80,
        head: [['Part Code', 'Description', 'Make', 'HSN', 'Type', 'UOM', 'Qty', 'Rate', 'Amount']],
        body: [
          [
            purchase.partCode || 'N/A',
            purchase.description || 'N/A',
            purchase.make || 'N/A',
            purchase.hsn || 'N/A',
            purchase.type || 'N/A',
            purchase.uom || 'N/A',
            purchase.purchaseQty || 0,
            (purchase.purchaseQty ? (purchase.purchaseAmount / purchase.purchaseQty).toFixed(2) : '0.00'),
            purchase.purchaseAmount.toFixed(2) || '0.00'
          ]
        ],
        styles: { fontSize: 10 },
        headStyles: { fillColor: [40, 180, 99] }
      });

      const finalY = doc.lastAutoTable.finalY + 10;
      doc.text(`Total Amount: ₹${purchase.purchaseAmount.toFixed(2) || '0.00'}`, 150, finalY);

      doc.setFontSize(10);
      doc.text('Thank you for your business!', 105, finalY + 20, { align: 'center' });
      doc.text('Technomens - Inventory Management System', 105, finalY + 30, { align: 'center' });

      doc.save(`Purchase_Bill_${purchase.id || purchase.date || 'bill'}.pdf`);
    }

    function generateSalesBillPDF(sale) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(20);
      doc.setTextColor(40, 180, 99);
      doc.text('TECHNOMENS', 105, 20, { align: 'center' });
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('SALES INVOICE', 105, 30, { align: 'center' });

      doc.setFontSize(12);
      doc.text(`Invoice No: ${sale.id || 'N/A'}`, 15, 45);
      doc.text(`Date: ${sale.date || 'N/A'}`, 15, 55);
      doc.text(`Customer: ${sale.soldTo || 'N/A'}`, 15, 65);

      doc.autoTable({
        startY: 80,
        head: [['Part Code', 'Description', 'Make', 'HSN', 'Type', 'UOM', 'Qty', 'Rate', 'Amount']],
        body: [
          [
            sale.partCode || 'N/A',
            sale.description || 'N/A',
            sale.make || 'N/A',
            sale.hsn || 'N/A',
            sale.type || 'N/A',
            sale.uom || 'N/A',
            sale.soldQty || 0,
            (sale.soldQty ? (sale.soldPrice / sale.soldQty).toFixed(2) : '0.00'),
            sale.soldPrice.toFixed(2) || '0.00'
          ]
        ],
        styles: { fontSize: 10 },
        headStyles: { fillColor: [40, 180, 99] }
      });

      const finalY = doc.lastAutoTable.finalY + 10;
      doc.text(`Total Amount: ₹${sale.soldPrice.toFixed(2) || '0.00'}`, 150, finalY);

      doc.setFontSize(10);
      doc.text('Thank you for your purchase!', 105, finalY + 20, { align: 'center' });
      doc.text('Technomens - Inventory Management System', 105, finalY + 30, { align: 'center' });

      doc.save(`Sales_Invoice_${sale.id || sale.date || 'invoice'}.pdf`);
    }

    downloadJsonBtn.addEventListener('click', () => {
      const item = {
        transactionType: document.getElementById('transaction-type').value || 'N/A',
        partCode: document.getElementById('part-code').value.trim() || 'N/A',
        description: document.getElementById('description-input').value.trim() || 'N/A',
        make: document.getElementById('make').value.trim() || 'N/A',
        hsn: document.getElementById('hsn').value.trim() || 'N/A',
        category: document.getElementById('category').value || 'N/A',
        type: document.getElementById('type').value || 'N/A',
        uom: document.getElementById('uom').value || 'N/A',
        purchaseAmount: parseFloat(document.getElementById('purchase-amount').value) || 0,
        purchaseQty: parseInt(document.getElementById('purchase-qty').value) || 0,
        purchaseFrom: document.getElementById('purchase-from').value.trim() || 'N/A',
        soldQty: parseInt(document.getElementById('sold-qty').value) || 0,
        soldPrice: parseFloat(document.getElementById('sold-price').value) || 0,
        soldTo: document.getElementById('sold-to').value.trim() || 'N/A',
        date: document.getElementById('date').value || 'N/A'
      };
      const json = JSON.stringify(item, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `item_${item.partCode || 'unknown'}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const type = transactionType.value;
      const partCode = document.getElementById('part-code').value.trim();
      const description = document.getElementById('description-input').value.trim();
      const make = document.getElementById('make').value.trim();
      const hsn = document.getElementById('hsn').value.trim();
      const category = document.getElementById('category').value;
      const itemType = document.getElementById('type').value;
      const uom = document.getElementById('uom').value;
      const date = document.getElementById('date').value;
      const purchaseAmount = parseFloat(document.getElementById('purchase-amount').value) || 0;
      const purchaseQty = parseInt(document.getElementById('purchase-qty').value) || 0;
      const purchaseFrom = document.getElementById('purchase-from').value.trim();
      const soldQty = parseInt(document.getElementById('sold-qty').value) || 0;
      const soldPrice = parseFloat(document.getElementById('sold-price').value) || 0;
      const soldTo = document.getElementById('sold-to').value.trim();

      if (!partCode || !description || !make || !hsn || !category || !itemType || !uom || !date) {
        alert('Please fill in all required fields correctly.');
        return;
      }

      if (type === 'purchase' && (purchaseAmount < 0 || purchaseQty < 0 || !purchaseFrom)) {
        alert('Please fill out all purchase fields correctly.');
        return;
      }

      if (type === 'sale' && (soldQty <= 0 || soldPrice <= 0 || !soldTo)) {
        alert('Please fill in all sale fields correctly.');
        return;
      }

      try {
        const itemId = `${partCode}_${make}_${hsn}`;
        const existingItem = await getItemFromFirestore(itemId);
        let newPurchaseQty = purchaseQty;
        let newSoldQty = soldQty;

        if (type === 'purchase') {
          if (existingItem && !currentItemId) {
            newPurchaseQty = existingItem.purchaseQty + purchaseQty;
          }

          const item = {
            id: itemId,
            partCode,
            description,
            make,
            hsn,
            category,
            type: itemType,
            uom,
            purchaseQty: newPurchaseQty,
            soldQty: existingItem ? existingItem.soldQty : 0,
            availableQty: newPurchaseQty - (existingItem ? existingItem.soldQty : 0),
            dateAdded: existingItem ? existingItem.dateAdded : date
          };

          const purchaseRecord = {
            id: itemId,
            partCode,
            description,
            make,
            hsn,
            category,
            type: itemType,
            uom,
            purchaseAmount,
            purchaseQty,
            purchaseFrom,
            date,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          await db.collection('inventory').doc(itemId).set(item);
          await db.collection('purchases').add(purchaseRecord);

          resetForm();
          alert(currentItemId ? 'Item updated successfully!' : 'Purchase added successfully!');
        } else if (type === 'sale') {
          if (!existingItem) {
            alert('Item not found.');
            return;
          }

          if (soldQty > existingItem.availableQty) {
            alert(`Cannot sell ${soldQty} items. Available: ${existingItem.availableQty}`);
            return;
          }

          newSoldQty = existingItem.soldQty + soldQty;
          const newAvailableQty = existingItem.purchaseQty - newSoldQty;

          if (newAvailableQty === 0 && !confirm('Selling all items will mark this item as fully sold. Proceed?')) {
            return;
          }

          const updatedItem = {
            ...existingItem,
            soldQty: newSoldQty,
            availableQty: newAvailableQty
          };

          const salesRecord = {
            id: itemId,
            partCode,
            description,
            make,
            hsn,
            category,
            type: itemType,
            uom,
            soldQty,
            soldPrice,
            soldTo,
            date,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          await db.collection('inventory').doc(itemId).set(updatedItem);
          await db.collection('sales').add(salesRecord);

          resetForm();
          alert('Sale recorded successfully!');
        }
      } catch (error) {
        console.error('Error saving record:', error);
        alert('Error saving record. Please try again.');
      }
    });

    dispatchBtn.addEventListener('click', async function() {
      const partCode = document.getElementById('part-code').value.trim();
      const description = document.getElementById('description-input').value.trim();
      const make = document.getElementById('make').value.trim();
      const hsn = document.getElementById('hsn').value.trim();
      const category = document.getElementById('category').value;
      const itemType = document.getElementById('type').value;
      const uom = document.getElementById('uom').value;
      const date = document.getElementById('date').value;
      const soldQty = parseInt(document.getElementById('sold-qty').value) || 0;
      const soldPrice = parseFloat(document.getElementById('sold-price').value) || 0;
      const soldTo = document.getElementById('sold-to').value.trim();

      if (!partCode || !description || !make || !hsn || !category || !itemType || !uom || !date ||
          soldQty <= 0 || soldPrice <= 0 || !soldTo) {
        alert('Please fill in all required fields for sale.');
        return;
      }

      try {
        const itemId = `${partCode}_${make}_${hsn}`;
        const item = await getItemFromFirestore(itemId);
        if (!item) {
          alert('Item not found.');
          return;
        }

        if (soldQty > item.availableQty) {
          alert(`Cannot sell ${soldQty} items. Available: ${item.availableQty}`);
          return;
        }

        const newSoldQty = item.soldQty + soldQty;
        const newAvailableQty = item.purchaseQty - newSoldQty;

        if (newAvailableQty === 0 && !confirm('Selling all items will mark this item as fully sold. Proceed?')) {
          return;
        }

        const updatedItem = {
          ...item,
          soldQty: newSoldQty,
          availableQty: newAvailableQty
        };

        const salesRecord = {
          id: itemId,
          partCode,
          description,
          make,
          hsn,
          category,
          type: itemType,
          uom,
          soldQty,
          soldPrice,
          soldTo,
          date,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('inventory').doc(itemId).set(updatedItem);
        await db.collection('sales').add(salesRecord);

        resetForm();
        alert('Sale recorded successfully!');
      } catch (error) {
        console.error('Error recording sale:', error);
        alert('Error recording sale. Please try again.');
      }
    });

    async function getItemFromFirestore(id) {
      try {
        const doc = await db.collection('inventory').doc(id).get();
        return doc.exists ? { id: doc.id, ...doc.data() } : null;
      } catch (error) {
        console.error('Error getting item:', error);
        throw error;
      }
    }

    async function deleteItemFromFirestore(id) {
      try {
        await db.collection('inventory').doc(id).delete();
      } catch (error) {
        console.error('Error deleting item:', error);
        throw error;
      }
    }

    function resetForm() {
      form.reset();
      document.getElementById('date').valueAsDate = new Date();
      qrImage.src = 'https://api.qrserver.com/v1/create-qr-code/?data=Default&size=100x100';
      document.getElementById('part-code').disabled = false;
      currentItemId = null;
      formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add Purchase or Sale';
      submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Purchase';
      dispatchBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      downloadJsonBtn.style.display = 'none';
      detailsPanel.style.display = 'none';
      toggleFormFields();
    }

    cancelBtn.addEventListener('click', resetForm);

    searchInput.addEventListener('input', () => {
      updateTable(currentItems);
    });

    let currentItems = [];

    function updateTable(items = []) {
      const filter = searchInput.value.toLowerCase();
      tableBody.innerHTML = '';

      if (!items.length) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="12" style="text-align: center; padding: 30px; color: #777;">
              <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
              No items found. Add purchases to get started!
            </td>
          </tr>
        `;
        return;
      }

      items
        .filter(item => {
          if (!item) return false;
          const partCode = item.partCode && typeof item.partCode === 'string' ? item.partCode.toLowerCase() : '';
          const description = item.description && typeof item.description === 'string' ? item.description.toLowerCase() : '';
          const make = item.make && typeof item.make === 'string' ? item.make.toLowerCase() : '';
          const hsn = item.hsn && typeof item.hsn === 'string' ? item.hsn.toLowerCase() : '';
          const category = item.category && typeof item.category === 'string' ? item.category.toLowerCase() : '';
          const type = item.type && typeof item.type === 'string' ? item.type.toLowerCase() : '';
          const uom = item.uom && typeof item.uom === 'string' ? item.uom.toLowerCase() : '';
          return partCode.includes(filter) || description.includes(filter) || make.includes(filter) ||
                 hsn.includes(filter) || category.includes(filter) || type.includes(filter) || uom.includes(filter);
        })
        .forEach(item => {
          const row = document.createElement('tr');
          row.setAttribute('data-id', item.id);

          const qrContainer = document.createElement('div');
          qrContainer.className = 'qr';
          const qrImg = document.createElement('img');
          qrImg.src = generateQRCode(generateQRData(item));
          qrImg.alt = 'QR Code';
          qrImg.title = 'QR Code';
          qrImg.style.maxWidth = '150px';
          qrImg.style.height = '50px';
          qrContainer.appendChild(qrImg);

          let qtyStatus = '';
          if (item.availableQty < 5) qtyStatus = 'status-low';
          else if (item.availableQty < 10) qtyStatus = 'status-medium';
          else qtyStatus = 'status-high';

          row.innerHTML = `
            <td>${item.partCode || 'N/A'}</td>
            <td>${item.description || 'N/A'}</td>
            <td>${item.make || 'N/A'}</td>
            <td>${item.hsn || 'N/A'}</td>
            <td>${item.category || 'N/A'}</td>
            <td>${item.type || 'N/A'}</td>
            <td>${item.uom || 'N/A'}</td>
            <td>${item.purchaseQty || 0}</td>
            <td>${item.soldQty || 0}</td>
            <td class="${qtyStatus}">${item.availableQty || 0}</td>
            <td></td>
            <td class="action-btns">
              <button class="action-btn edit-btn" onclick="editItem('${item.id}')">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="action-btn delete-btn" onclick="deleteItem('${item.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </td>
          `;

          const qrCell = row.querySelector('td:nth-child(11)');
          qrCell.appendChild(qrContainer);

          row.addEventListener('click', (e) => {
            if (!e.target.closest('.action-btn')) {
              showItemDetails(item.id);
            }
          });

          tableBody.appendChild(row);
        });
    }

    function updatePurchaseTable(purchases = []) {
      purchaseBody.innerHTML = '';
      if (!purchases.length) {
        purchaseBody.innerHTML = `
          <tr>
            <td colspan="12" style="text-align: center; padding: 30px; color: #777;">
              No purchase records found.
            </td>
          </tr>
        `;
        return;
      }

      purchases.forEach(purchase => {
        if (!purchase) return;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${purchase.partCode || 'N/A'}</td>
          <td>${purchase.description || 'N/A'}</td>
          <td>${purchase.make || 'N/A'}</td>
          <td>${purchase.hsn || 'N/A'}</td>
          <td>${purchase.category || 'N/A'}</td>
          <td>${purchase.type || 'N/A'}</td>
          <td>${purchase.uom || 'N/A'}</td>
          <td>${typeof purchase.purchaseAmount === 'number' ? purchase.purchaseAmount.toFixed(2) : '0.00'}</td>
          <td>${purchase.purchaseQty || 0}</td>
          <td>${purchase.purchaseFrom || 'N/A'}</td>
          <td>${purchase.date || 'N/A'}</td>
          <td class="action-btns">
            <button class="action-btn" onclick="downloadPurchaseBill('${purchase.id}')" style="background-color: #2196F3; color: white;">
              <i class="fas fa-download"></i> Download Bill
            </button>
          </td>
        `;
        purchaseBody.appendChild(row);
      });
    }

    function updateSalesTable(sales = []) {
      salesBody.innerHTML = '';
      if (!sales.length) {
        salesBody.innerHTML = `
          <tr>
            <td colspan="12" style="text-align: center; padding: 30px; color: #777;">
              No sales records found.
            </td>
          </tr>
        `;
        return;
      }

      sales.forEach(sale => {
        if (!sale) return;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sale.partCode || 'N/A'}</td>
          <td>${sale.description || 'N/A'}</td>
          <td>${sale.make || 'N/A'}</td>
          <td>${sale.hsn || 'N/A'}</td>
          <td>${sale.category || 'N/A'}</td>
          <td>${sale.type || 'N/A'}</td>
          <td>${sale.uom || 'N/A'}</td>
          <td>${sale.soldQty || 0}</td>
          <td>${typeof sale.soldPrice === 'number' ? sale.soldPrice.toFixed(2) : '0.00'}</td>
          <td>${sale.soldTo || 'N/A'}</td>
          <td>${sale.date || 'N/A'}</td>
          <td class="action-btns">
            <button class="action-btn" onclick="downloadSalesBill('${sale.id}')" style="background-color: #2196F3; color: white;">
              <i class="fas fa-download"></i> Download Invoice
            </button>
          </td>
        `;
        salesBody.appendChild(row);
      });
    }

    async function showItemDetails(itemId) {
      try {
        const item = await getItemFromFirestore(itemId);
        if (!item) {
          detailsPanel.style.display = 'none';
          return;
        }

        const purchases = await db.collection('purchases')
          .where('partCode', '==', item.partCode)
          .where('make', '==', item.make)
          .where('hsn', '==', item.hsn)
          .orderBy('timestamp', 'desc')
          .get();

        const sales = await db.collection('sales')
          .where('partCode', '==', item.partCode)
          .where('make', '==', item.make)
          .where('hsn', '==', item.hsn)
          .orderBy('timestamp', 'desc')
          .get();

        let purchaseDetails = '<div class="spec-value"><div class="detail-label">Purchase History</div>';
        if (purchases.empty) {
          purchaseDetails += 'No purchase records found.';
        } else {
          purchaseDetails += '<ul>';
          purchases.forEach(doc => {
            const p = { id: doc.id, ...doc.data() };
            purchaseDetails += `<li>${p.date || 'N/A'}: ${p.purchaseQty || 0} ${p.uom || 'units'} at ₹${typeof p.purchaseAmount === 'number' ? p.purchaseAmount.toFixed(2) : '0.00'} from ${p.purchaseFrom || 'N/A'} <button class="action-btn" onclick="downloadPurchaseBill('${p.id}')" style="background-color: #2196F3; color: white; margin-left: 10px;">Download Bill</button></li>`;
          });
          purchaseDetails += '</ul>';
        }
        purchaseDetails += '</div>';

        let salesDetails = '<div class="spec-value"><div class="detail-label">Sales History</div>';
        if (sales.empty) {
          salesDetails += 'No sales records found.';
        } else {
          salesDetails += '<ul>';
          sales.forEach(doc => {
            const s = { id: doc.id, ...doc.data() };
            salesDetails += `<li>${s.date || 'N/A'}: ${s.soldQty || 0} ${s.uom || 'units'} at ₹${typeof s.soldPrice === 'number' ? s.soldPrice.toFixed(2) : '0.00'} to ${s.soldTo || 'N/A'} <button class="action-btn" onclick="downloadSalesBill('${s.id}')" style="background-color: #2196F3; color: white; margin-left: 10px;">Download Invoice</button></li>`;
          });
          salesDetails += '</ul>';
        }
        salesDetails += '</div>';

        detailsContent.innerHTML = `
          <div class="detail-item">
            <div class="detail-label">Part Code</div>
            <div class="detail-value">${item.partCode || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Description</div>
            <div class="detail-value">${item.description || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Make</div>
            <div class="detail-value">${item.make || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">HSN Code</div>
            <div class="detail-value">${item.hsn || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Category</div>
            <div class="detail-value">${item.category || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Type</div>
            <div class="detail-value">${item.type || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Unit of Measurement</div>
            <div class="detail-value">${item.uom || 'N/A'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Purchase Quantity</div>
            <div class="detail-value">${item.purchaseQty || 0} ${item.uom || 'units'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Sold Quantity</div>
            <div class="detail-value">${item.soldQty || 0} ${item.uom || 'units'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Available Quantity</div>
            <div class="detail-value">${item.availableQty || 0} ${item.uom || 'units'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Date Added</div>
            <div class="detail-value">${item.dateAdded || 'Not specified'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">QR Code</div>
            <div class="detail-value" id="detail-qr"></div>
          </div>
          ${purchaseDetails}
          ${salesDetails}
        `;

        try {
          const qrImg = document.createElement('img');
          qrImg.src = generateQRCode(generateQRData(item));
          qrImg.alt = 'QR Code';
          qrImg.title = 'QR Code';
          qrImg.style.maxWidth = '150px';
          qrImg.style.height = '60px';
          document.getElementById('detail-qr').appendChild(qrImg);
        } catch (error) {
          console.error('Error generating detail QR code:', error);
          document.getElementById('detail-qr').innerHTML = 'Invalid QR code';
        }

        detailsPanel.style.display = 'block';
        detailsPanel.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Error showing item details:', error);
        alert('Error loading item details.');
      }
    }

    async function deleteItem(itemId) {
      if (confirm('Are you sure you want to delete this item and its records?')) {
        try {
          await deleteItemFromFirestore(itemId);
          if (detailsPanel.style.display === 'block' &&
              document.querySelector('.details-content').innerHTML.includes(itemId)) {
            detailsPanel.style.display = 'none';
          }
          alert('Item deleted successfully!');
        } catch (error) {
          alert('Error deleting item. Please try again.');
          console.error('Delete error:', error);
        }
      }
    }

    async function editItem(itemId) {
      try {
        const item = await getItemFromFirestore(itemId);
        if (!item) return;

        document.getElementById('part-code').value = item.partCode || '';
        document.getElementById('part-code').disabled = true;
        document.getElementById('description-input').value = item.description || '';
        document.getElementById('make').value = item.make || '';
        document.getElementById('hsn').value = item.hsn || '';
        document.getElementById('category').value = item.category || 'Mechanical';
        document.getElementById('type').value = item.type || 'Raw Material';
        document.getElementById('uom').value = item.uom || 'Pieces';
        document.getElementById('date').value = item.dateAdded || new Date().toISOString().split('T')[0];
        document.getElementById('purchase-qty').value = item.purchaseQty || 0;
        document.getElementById('sold-qty').value = item.soldQty || 0;

        qrImage.src = generateQRCode(generateQRData(item));
        downloadJsonBtn.style.display = 'flex';

        currentItemId = item.id;
        formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Item';
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Item';
        dispatchBtn.style.display = 'none';
        cancelBtn.style.display = 'flex';
        transactionType.value = 'purchase';
        toggleFormFields();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        console.error('Error editing item:', error);
        alert('Error loading item for editing.');
      }
    }

    function switchTab(tab) {
      inventoryTab.classList.remove('active');
      purchaseTab.classList.remove('active');
      salesTab.classList.remove('active');

      inventorySection.style.display = 'none';
      purchaseSection.style.display = 'none';
      salesSection.style.display = 'none';

      if (tab === 'inventory') {
        inventoryTab.classList.add('active');
        inventorySection.style.display = 'block';
      } else if (tab === 'purchase') {
        purchaseTab.classList.add('active');
        purchaseSection.style.display = 'block';
      } else if (tab === 'sales') {
        salesTab.classList.add('active');
        salesSection.style.display = 'block';
      }
    }

    inventoryTab.addEventListener('click', () => switchTab('inventory'));
    purchaseTab.addEventListener('click', () => switchTab('purchase'));
    salesTab.addEventListener('click', () => switchTab('sales'));

    function addChatbotMessage(message, isUser) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chatbot-message ${isUser ? 'user' : 'bot'}`;
      messageDiv.textContent = message;
      chatbotMessages.appendChild(messageDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function handleChatbotResponse(message) {
      const lowerMessage = message.toLowerCase().trim();
      let response = '';

      if (isSupportMode) {
        if (lowerMessage.includes('help') || lowerMessage.includes('support')) {
          response = 'Please describe your issue, and I’ll connect you with the support team. For urgent queries, email support@technomens.com.';
        } else if (lowerMessage.includes('inventory') || lowerMessage.includes('add item')) {
          response = 'To add an item, select "Purchase" in the Transaction Type dropdown, fill in the required fields (Part Code, Description, Make, HSN, Category, Type, UOM, Date, Purchase Amount, Quantity, and Supplier), then click "Add Purchase". Need more help?';
        } else if (lowerMessage.includes('sale') || lowerMessage.includes('record sale')) {
          response = 'To record a sale, select "Sale" in the Transaction Type dropdown, fill in the required fields (Part Code, Description, Make, HSN, Category, Type, UOM, Date, Sold Quantity, Price, and Customer), then click "Record Sale". Any issues?';
        } else if (lowerMessage.includes('qr code') || lowerMessage.includes('qr')) {
          response = 'The QR code is generated automatically based on item details. You can download the item data as JSON using the "Download QR JSON" button when editing an item.';
        } else if (lowerMessage.includes('bill') || lowerMessage.includes('invoice')) {
          response = 'To download a bill or invoice, go to the Purchase or Sales Sheet tab and click "Download Bill" or "Download Invoice" for the respective record.';
        } else if (lowerMessage.includes('uom') || lowerMessage.includes('unit of measurement')) {
          response = 'UOM (Unit of Measurement) specifies how the item quantity is measured (e.g., Pieces, Kg, Liters). Select the appropriate UOM when adding items.';
        } else {
          response = 'I’m here to help with inventory management issues. Please provide more details or contact support@technomens.com for further assistance.';
        }
      } else {
        if (lowerMessage.includes('inventory tips') || lowerMessage.includes('best practices')) {
          response = 'For effective inventory management, regularly update stock levels, categorize items clearly, use proper UOM, and use QR codes for quick tracking. Would you like specific tips for your category (e.g., Electrical)?';
        } else if (lowerMessage.includes('electrical') || lowerMessage.includes('mechanical')) {
          response = `For ${lowerMessage.includes('electrical') ? 'Electrical' : 'Mechanical'} items, ensure proper storage to prevent damage, track HSN codes for compliance, and use appropriate UOM (e.g., Pieces for components, Meters for wires). Need storage tips?`;
        } else if (lowerMessage.includes('hsn code') || lowerMessage.includes('hsn')) {
          response = 'HSN codes classify goods for taxation. Ensure accuracy in your HSN entries to avoid compliance issues. Want help finding an HSN code?';
        } else if (lowerMessage.includes('uom') || lowerMessage.includes('unit of measurement')) {
          response = 'Choose UOM based on how you purchase and sell items. Common UOMs: Pieces (individual items), Kg (weight), Liters (volume), Meters (length), Box (packaged items), Set (grouped items), Pair (items sold in twos).';
        } else {
          response = 'I can provide local knowledge on inventory practices. Ask about best practices, specific categories, or compliance tips!';
        }
      }

      setTimeout(() => {
        addChatbotMessage(response, false);
      }, 500);
    }

    chatbotToggle.addEventListener('click', () => {
      const isOpen = chatbotWindow.style.display === 'flex';
      chatbotWindow.style.display = isOpen ? 'none' : 'flex';
      if (!isOpen) {
        chatbotInput.focus();
      }
    });

    chatbotSend.addEventListener('click', () => {
      const message = chatbotInput.value.trim();
      if (message) {
        addChatbotMessage(message, true);
        handleChatbotResponse(message);
        chatbotInput.value = '';
      }
    });

    chatbotInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && chatbotInput.value.trim()) {
        addChatbotMessage(chatbotInput.value.trim(), true);
        handleChatbotResponse(chatbotInput.value.trim());
        chatbotInput.value = '';
      }
    });

    chatbotModeToggle.addEventListener('click', () => {
      isSupportMode = !isSupportMode;
      chatbotTitle.textContent = isSupportMode ? 'Support Chatbot' : 'Local Knowledge Chatbot';
      chatbotModeToggle.textContent = isSupportMode ? 'Switch to Local Knowledge' : 'Switch to Support';
      chatbotMessages.innerHTML = `<div class="chatbot-message bot">${
        isSupportMode
          ? 'Hello! How can I assist you with inventory management today?'
          : 'Ask me about inventory management best practices or local knowledge!'
      }</div>`;
    });

    function initApp() {
      toggleFormFields();
      unsubscribeItems = db.collection('inventory').onSnapshot(snapshot => {
        currentItems = [];
        snapshot.forEach(doc => {
          const item = { id: doc.id, ...doc.data() };
          if (item && item.id && item.partCode && item.description && item.make && item.hsn &&
              item.category && item.type && item.uom && typeof item.purchaseQty === 'number' &&
              typeof item.soldQty === 'number') {
            currentItems.push(item);
          } else {
            console.warn('Invalid item data skipped:', item);
          }
        });
        updateTable(currentItems);
      }, error => {
        console.error('Error getting inventory items:', error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="12" class="loading-message">Error loading items. Please try again later.</td>
          </tr>
        `;
      });

      unsubscribePurchases = db.collection('purchases').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        const purchases = [];
        snapshot.forEach(doc => {
          const purchase = { id: doc.id, ...doc.data() };
          if (purchase && purchase.partCode && purchase.description && purchase.make &&
              purchase.hsn && purchase.category && purchase.type && purchase.uom) {
            purchases.push(purchase);
          } else {
            console.warn('Invalid purchase data skipped:', purchase);
          }
        });
        updatePurchaseTable(purchases);
      }, error => {
        console.error('Error loading purchases:', error);
        purchaseBody.innerHTML = `
          <tr>
            <td colspan="12" class="loading-message">Error loading purchases. Please try again later.</td>
          </tr>
        `;
      });

      unsubscribeSales = db.collection('sales').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        const sales = [];
        snapshot.forEach(doc => {
          const sale = { id: doc.id, ...doc.data() };
          if (sale && sale.partCode && sale.description && sale.make &&
              sale.hsn && sale.category && sale.type && sale.uom) {
            sales.push(sale);
          } else {
            console.warn('Invalid sale data skipped:', sale);
          }
        });
        updateSalesTable(sales);
      }, error => {
        console.error('Error loading sales:', error);
        salesBody.innerHTML = `
          <tr>
            <td colspan="12" class="loading-message">Error loading sales. Please try again later.</td>
          </tr>
        `;
      });

      db.collection('inventory').get().then(snapshot => {
        if (snapshot.empty) {
          addSampleData();
        }
      });
    }

    async function addSampleData() {
      const sampleItems = [
        {
          id: "PC001_Arduino_123456",
          partCode: "PC001",
          description: "Arduino Uno",
          make: "Arduino",
          hsn: "123456",
          category: "Electrical",
          type: "Finished Goods",
          uom: "Pieces",
          purchaseQty: 100,
          soldQty: 20,
          availableQty: 80,
          dateAdded: new Date().toISOString().split('T')[0]
        },
        {
          id: "PC002_Generic_234567",
          partCode: "PC002",
          description: "Jumper Wires",
          make: "Generic",
          hsn: "234567",
          category: "Electrical",
          type: "Consumables",
          uom: "Meters",
          purchaseQty: 200,
          soldQty: 50,
          availableQty: 150,
          dateAdded: new Date().toISOString().split('T')[0]
        }
      ];

      const samplePurchases = [
        {
          id: "PC001_Arduino_123456",
          partCode: "PC001",
          description: "Arduino Uno",
          make: "Arduino",
          hsn: "123456",
          category: "Electrical",
          type: "Finished Goods",
          uom: "Pieces",
          purchaseAmount: 1500.00,
          purchaseQty: 100,
          purchaseFrom: "Supplier A",
          date: new Date().toISOString().split('T')[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        },
        {
          id: "PC002_Generic_234567",
          partCode: "PC002",
          description: "Jumper Wires",
          make: "Generic",
          hsn: "234567",
          category: "Electrical",
          type: "Consumables",
          uom: "Meters",
          purchaseAmount: 500.00,
          purchaseQty: 200,
          purchaseFrom: "Supplier B",
          date: new Date().toISOString().split('T')[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }
      ];

      const sampleSales = [
        {
          id: "PC001_Arduino_123456",
          partCode: "PC001",
          description: "Arduino Uno",
          make: "Arduino",
          hsn: "123456",
          category: "Electrical",
          type: "Finished Goods",
          uom: "Pieces",
          soldQty: 20,
          soldPrice: 2000.00,
          soldTo: "Customer X",
          date: new Date().toISOString().split('T')[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        },
        {
          id: "PC002_Generic_234567",
          partCode: "PC002",
          description: "Jumper Wires",
          make: "Generic",
          hsn: "234567",
          category: "Electrical",
          type: "Consumables",
          uom: "Meters",
          soldQty: 50,
          soldPrice: 750.00,
          soldTo: "Customer Y",
          date: new Date().toISOString().split('T')[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }
      ];

      try {
        const batch = db.batch();
        for (const item of sampleItems) {
          const doc = await db.collection('inventory').doc(item.id).get();
          if (!doc.exists) {
            const docRef = db.collection('inventory').doc(item.id);
            batch.set(docRef, item);
          }
        }
        for (const purchase of samplePurchases) {
          const docRef = db.collection('purchases').doc();
          batch.set(docRef, purchase);
        }
        for (const sale of sampleSales) {
          const docRef = db.collection('sales').doc();
          batch.set(docRef, sale);
        }
        await batch.commit();
        console.log('Sample data added successfully');
      } catch (error) {
        console.error('Error adding sample data:', error);
      }
    }

    window.onload = initApp;

    window.addEventListener('beforeunload', () => {
      if (unsubscribeItems) unsubscribeItems();
      if (unsubscribePurchases) unsubscribePurchases();
      if (unsubscribeSales) unsubscribeSales();
    });

    window.showItemDetails = showItemDetails;
    window.editItem = editItem;
    window.deleteItem = deleteItem;
    window.downloadPurchaseBill = downloadPurchaseBill;
    window.downloadSalesBill = downloadSalesBill;
  </script>
</body>
</html>